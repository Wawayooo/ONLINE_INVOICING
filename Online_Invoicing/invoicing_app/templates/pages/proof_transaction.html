{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proof of Transaction</title>
  <link rel="stylesheet" href="{% static 'css/proof_transaction.css' %}">
  <link rel="stylesheet" href="{% static 'css/proofTransactionDesign2.css' %}">
  <link rel="stylesheet" href="{% static 'css/typing_label.css' %}">
</head>
<body>
  <div id="loadingModal" class="loading-modal">
    <div class="loading-content">
      <div class="loading-spinner">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
      </div>
      <h2 class="loading-text">Loading Transaction Details</h2>
      <p class="loading-subtext">Please wait while we retrieve your information...</p>
      <div class="loading-progress">
        <div class="progress-bar"></div>
      </div>
    </div>
  </div>

  <div class="container" id="mainContent" style="display: none;">
    <h1>üìÑ Proof of Transaction</h1>

    <div class="room-info">      
      <div class="body_type">
        <div class="typing-container" id="typing"></div>
      </div>
      
      <div class="qr-section">
        <div class="qr-container">
          <div class="qr-header">
            <h3>üîê Authenticity Verification</h3>
            <span class="verified-badge">‚úì Verified</span>
          </div>
          <div id="qrcode" class="qr-code-display"></div>
          <p class="qr-description">
            <strong>Scan for Authenticity:</strong> This QR code serves as proof that this invoice was 
            generated by our secure system and has not been tampered with or modified. Each transaction 
            is cryptographically signed and can be verified through this unique code.
          </p>
          <div class="qr-info-box">
            <div class="info-item">
              <span class="info-icon">üîí</span>
              <span class="info-text">System Generated</span>
            </div>
            <div class="info-item">
              <span class="info-icon">‚úÖ</span>
              <span class="info-text">Tamper-Proof</span>
            </div>
          </div>
          <button id="copyLinkBtn" class="copy-link-btn">üìã Copy Verification Link</button>
        </div>
      </div>
    </div>

    <div class="proof-wrapper">
      <div class="seller-card">
        <div class="seller-Info">
          <h2>Seller Information</h2>
          <p><strong>Name:</strong>{{ seller.fullname }}</p>
          <p><strong>Email:</strong>{{ seller.email }}</p>
          <p><strong>Phone:</strong>{{ seller.phone }}</p>
          <p><strong>Social:</strong>{{ seller.social_media }}</p>
        </div>
        <div class="Seller_Img">
          {% if seller.profile_picture %}
            <img src="{{ seller.profile_picture.url }}" alt="Seller Profile Picture" class="profile-image">
          {% endif %}
        </div>
      </div>

      <div class="buyer-card">
        <div class="Buyer_Info">
          <h2>Buyer Information</h2>
          <p><strong>Name:</strong> {{ buyer.fullname }}</p>
          <p><strong>Email:</strong> {{ buyer.email }}</p>
          <p><strong>Phone:</strong> {{ buyer.phone }}</p>
          <p><strong>Social:</strong> {{ buyer.social_media }}</p>
        </div>
        <div class="Buyer_Img">
           {% if buyer.profile_picture %}
              <img src="{{ buyer.profile_picture.url }}" alt="Buyer Profile Picture" class="profile-image">
            {% endif %}
        </div>
      </div>

      <div class="invoice-card">
        <div class="Invoice_Header"><h2>Invoice Details</h2></div>
        <div class="Invoice_Notes">
          <p><strong>Invoice Date:</strong> {{ invoice.invoice_date }}</p>
          <p><strong>Due Date:</strong> {{ invoice.due_date }}</p>
          <p><strong>Status:</strong> {{ invoice.status }}</p>
        </div>

        <div class="Invoice_Items">
          <h3 style="color: green;">SUCCESSFUL TRANSACTION</h3>

          {% if invoice.items.count > 0 %}
            <table class="invoice-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Description</th>
                  <th>Quantity</th>
                  <th>Unit Price</th>
                  <th>Line Total</th>
                </tr>
              </thead>
              <tbody>
                {% for item in invoice.items.all %}
                <tr>
                  <td>{{ item.product_name }}</td>
                  <td>{{ item.description|default:"-" }}</td>
                  <td>{{ item.quantity }}</td>
                  <td>‚Ç±{{ item.unit_price|floatformat:2 }}</td>
                  <td>‚Ç±{{ item.line_total|floatformat:2 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          <div class="Invoice_Total">
            <p><strong>Grand Total:</strong> ‚Ç±{{ invoice.total_amount }}</p>
          </div>
          {% else %}
            <div class="single-item-card">
              <h3>Item</h3>
              <div class="single-item-row">
                <span class="label">Product:</span>
                <span class="value">{{ invoice.description }}</span>
              </div>
              <div class="single-item-row">
                <span class="label">Quantity:</span>
                <span class="value">{{ invoice.quantity }}</span>
              </div>
              <div class="single-item-row">
                <span class="label">Unit Price:</span>
                <span class="value">‚Ç±{{ invoice.unit_price|floatformat:2 }}</span>
              </div>
              <div class="single-item-row total">
                <span class="label">Line Total:</span>
                <span class="value" id="inv_line_total">‚Ç±{{ invoice.line_total|floatformat:2 }}</span>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

    </div>

    </div>

    <div class="download-section">
    <a href="{% url 'proof_of_transaction_pdf' room_hash %}" 
      class="btn btn-primary" target="_blank">
      ‚¨áÔ∏è DOWNLOAD NOW
    </a>
</div>


</div>

</div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script src="{% static 'js/proof_transaction.js' %}"></script>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      const loadingModal = document.getElementById('loadingModal');
      const mainContent = document.getElementById('mainContent');

      const roomHash = "{{ room_hash }}"; 
      const buyerHash = "{{ buyer_hash|default:'' }}";
      let shareableLink;

      const origin = window.location.origin.replace(/\/$/, '');
      if (buyerHash) {
        shareableLink = `${origin}/buyer_invoice_room/${roomHash}/${buyerHash}/`;
      } else {
        shareableLink = `${origin}/buyer_room/${roomHash}/`;
      }


      setTimeout(function() {
        loadingModal.style.opacity = '0';
        setTimeout(function() {
          loadingModal.style.display = 'none';
          mainContent.style.display = 'block';
          mainContent.style.animation = 'fadeInUp 0.6s ease-out';

          generateQRCode();
        }, 300);
      }, 2000);

      function generateQRCode() {
        const qrcodeContainer = document.getElementById("qrcode");
        qrcodeContainer.innerHTML = '';

        new QRCode(qrcodeContainer, {
          text: shareableLink,
          width: 200,
          height: 200,
          colorDark: "#667eea",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
      }

      document.getElementById('copyLinkBtn').addEventListener('click', function() {
        navigator.clipboard.writeText(shareableLink).then(function() {
          const btn = document.getElementById('copyLinkBtn');
          const originalText = btn.innerHTML;
          btn.innerHTML = '‚úÖ Link Copied!';
          btn.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';

          setTimeout(function() {
            btn.innerHTML = originalText;
            btn.style.background = '';
          }, 2000);
        });
      });
    });
  </script>
  
  <script>
    const text = "Bound By Truth & Guarded Flame, No Hand May Alter, For All Is Sealed In Steadfast Security.";
    const typingElement = document.getElementById("typing");
    let index = 0;

    function typeEffect() {
      if (index < text.length) {
        typingElement.textContent += text.charAt(index);
        index++;
        setTimeout(typeEffect, 80);
      } else {
        setTimeout(() => {
          typingElement.textContent = "";
          index = 0;
          typeEffect();
        }, 3000);
      }
    }

    typeEffect();
  </script>
</body>
</html>


