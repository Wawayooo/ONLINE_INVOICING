{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Data - Invoicing System</title>
  <link rel="stylesheet" href="{% static 'css/alldata.css' %}">
</head>
<body>
  <div class="container">
    <h1>ðŸ“Š All Data</h1>

    {% for room in rooms %}
    <div class="room-card">
      <h2>Room {{ room.room_hash }}</h2>
      <p><strong>Seller Hash:</strong> {{ room.seller_hash }}</p>
      <p><strong>Verification Key:</strong> {{ room.verification_key }}</p>
      <p><strong>Created At:</strong> {{ room.created_at }}</p>
      <p><strong>Updated At:</strong> {{ room.updated_at }}</p>

      <h3>Seller Information</h3>
      {% if room.seller %}
        <p><strong>Name:</strong> {{ room.seller.fullname }}</p>
        <p><strong>Email:</strong> {{ room.seller.email|default:"-" }}</p>
        <p><strong>Phone:</strong> {{ room.seller.phone|default:"-" }}</p>
        <p><strong>Social Media:</strong> {{ room.seller.social_media|default:"-" }}</p>
        <p><strong>Secret Key (hashed):</strong> {{ room.seller.secret_key }}</p>
        <p><strong>Created At:</strong> {{ room.seller.created_at }}</p>
        {% if room.seller.profile_picture %}
          <img src="{{ room.seller.profile_picture.url }}" alt="Seller Profile" class="profile-img">
        {% endif %}
      {% else %}
        <p>N/A</p>
      {% endif %}

      <h3>Buyer Information</h3>
      {% if room.buyer %}
        <p><strong>Name:</strong> {{ room.buyer.fullname }}</p>
        <p><strong>Email:</strong> {{ room.buyer.email|default:"-" }}</p>
        <p><strong>Phone:</strong> {{ room.buyer.phone|default:"-" }}</p>
        <p><strong>Social Media:</strong> {{ room.buyer.social_media|default:"-" }}</p>
        <p><strong>Buyer Hash:</strong> {{ room.buyer.buyer_hash }}</p>
        <p><strong>Created At:</strong> {{ room.buyer.created_at }}</p>
        {% if room.buyer.profile_picture %}
          <img src="{{ room.buyer.profile_picture.url }}" alt="Buyer Profile" class="profile-img">
        {% endif %}
      {% else %}
        <p>N/A</p>
      {% endif %}

      <h3>Invoice Information</h3>
      {% if room.invoice %}
        <p><strong>Status:</strong> {{ room.invoice.status|title }}</p>
        <p><strong>Description:</strong> {{ room.invoice.description }}</p>
        <p><strong>Quantity:</strong> {{ room.invoice.quantity }}</p>
        <p><strong>Unit Price:</strong> â‚±{{ room.invoice.unit_price|floatformat:2 }}</p>
        <p><strong>Line Total:</strong> â‚±{{ room.invoice.line_total|floatformat:2 }}</p>
        <p><strong>Payment Method:</strong> {{ room.invoice.payment_method }}</p>
        <p><strong>Buyer Approved At:</strong> {{ room.invoice.buyer_approved_at }}</p>
        <p><strong>Buyer Paid At:</strong> {{ room.invoice.buyer_paid_at }}</p>
        <p><strong>Seller Confirmed At:</strong> {{ room.invoice.seller_confirmed_at }}</p>
        <p><strong>Created At:</strong> {{ room.invoice.created_at }}</p>
        <p><strong>Updated At:</strong> {{ room.invoice.updated_at }}</p>

        <h4>Invoice Items</h4>
        <table>
          <thead>
            <tr>
              <th>Product</th>
              <th>Description</th>
              <th>Quantity</th>
              <th>Unit Price</th>
              <th>Line Total</th>
            </tr>
          </thead>
          <tbody>
            {% for item in room.invoice.items.all %}
            <tr>
              <td>{{ item.product_name }}</td>
              <td>{{ item.description|default:"-" }}</td>
              <td>{{ item.quantity }}</td>
              <td>â‚±{{ item.unit_price|floatformat:2 }}</td>
              <td>â‚±{{ item.line_total|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5">No items</td></tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>No invoice data</p>
      {% endif %}

      <h3>Negotiation History</h3>
      <ul>
        {% for history in room.history.all %}
          <li>{{ history.actor }} - {{ history.action }} ({{ history.created_at }}) Notes: {{ history.notes|default:"-" }}</li>
        {% empty %}
          <li>No negotiation history</li>
        {% endfor %}
      </ul>

      <h3>Multi-Item Negotiation History</h3>
      <ul>
        {% for history in room.multi_item_history.all %}
          <li>{{ history.actor }} - {{ history.action }} ({{ history.created_at }}) Notes: {{ history.notes|default:"-" }}</li>
        {% empty %}
          <li>No multi-item negotiation history</li>
        {% endfor %}
      </ul>

      <div class="actions">
        {% if room.buyer %}
          <a href="{% url 'buyer_invoice_room' room.room_hash room.buyer.buyer_hash %}" class="btn-view">View Buyer Room</a>
        {% else %}
          <span class="btn-disabled">No Buyer</span>
        {% endif %}
        <form method="POST" action="{% url 'delete_room' room.id %}" 
              onsubmit="return confirm('Are you sure you want to delete this room?');" 
              style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn-delete">Delete Room</button>
        </form>
      </div>
    </div>
    {% empty %}
    <p style="text-align:center;">ðŸš« No rooms or invoices available.</p>
    {% endfor %}
  </div>
</body>
</html>
